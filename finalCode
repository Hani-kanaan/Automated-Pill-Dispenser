#define NUM_PILLS 3
#include <Servo.h>
#include <LiquidCrystal_I2C.h>
#include <Stepper.h>
#include <EEPROM.h>
LiquidCrystal_I2C lcd(0x27, 16, 2);
int selectButton = 16 ;
int incButton = 15 ;
int minButton = 14;
int count = 0 ;

#include <virtuabotixRTC.h>                                                                              
virtuabotixRTC myRTC(6, 7, 5); // CLK , DATA , RST

Servo myservo; 
#define ledPin 7 //test for bluetooth
int state = 0; // state for led 

const int stepsPerRevolution = 2048;  // change this to fit the number of steps per revolution
Stepper myStepper(stepsPerRevolution, 8, 9, 10, 11);
int currentHour;

  struct pill{
  char name[20];
  int hour;
  int min;// means 1 byte
  int stepperPos; 
};
struct pill pills[NUM_PILLS] = {
    {"pill 1" , 8 , 00 , 10},
    {"pill 2" , 9 , 45 , 50},
    {"pill 3" , 10 , 15 , 100},
};




void setup() {
  myStepper.setSpeed(10);
Serial.begin(9600);
pinMode(ledPin, OUTPUT);
digitalWrite(ledPin, LOW);
lcd.setCursor(0, 0);

pinMode(selectButton, INPUT);
pinMode(incButton, INPUT);
pinMode(minButton, INPUT);

lcd.begin();
lcd.backlight();
myRTC.setDS1302Time(40, 01, 12, 5,15, 4, 2023);//but remember to "comment/remove" this function once you're done as I did
 //The setup is done only one time and the module will continue counting it automatically
 

myservo.attach(3);
//pills[0] = EEPROM.get(int idx, T &t)
pill custom; //Variable to store custom object read from EEPROM.
for (int i = 0 ; i<4 ; i++){
EEPROM.get(i, custom );
Serial.println( custom.name );
  Serial.println( custom.hour );
  Serial.println( custom.min );
  int hour= custom.hour;
  int min = custom.min;
  String name = custom.name;
  //pills[i].name = name;
  pills[i].hour =hour;
  pills[i].min = min;
  
}
}

void loop() {
//myStepper.step(stepsPerRevolution);
//delay(500);

 lcd.setCursor(0, 0);
  
 int buttonState1 = digitalRead(selectButton);
 int buttonState2 = digitalRead(incButton);
int buttonState3 = digitalRead(minButton);


if (buttonState1 == HIGH) {
    lcd.clear();

count++; //connect this pin to avoid infinite loop
if(count == 3){
  count = 0;
}}

if(buttonState2 == HIGH){
    lcd.clear();

  pills[count].hour++;
  if(pills[count].hour > 23){
    pills[count].hour= 0 ;
  }}
 


  if(buttonState3 == HIGH){
      lcd.clear();
  pills[count].min = pills[count].min+15 ;
  if(pills[count].min > 45){
    pills[count].min= 0 ;
  }
}
lcd.print(pills[count].name);
lcd.print(" ");
lcd.print(pills[count].hour);
lcd.print(":");
lcd.print(pills[count].min);
delay(100);

 if(Serial.available() > 0){ // Checks whether data is coming from the serial port
  //  state = Serial.read(); // Reads the data from the serial port
 String input =  Serial.readStringUntil('\n'); // Read the input string until newline character
 char *idx_str = strtok(input.c_str(), " ");
char *hour_str = strtok(NULL, " "); // Split the input string into Hour and Minute using space delimiter
char *min_str = strtok(NULL, " ");
//if(hour_str != NULL && min_str != NULL){

   int idx = atoi(idx_str);
  int hour = atoi(hour_str); // Convert the Hour string into integer
  int min = atoi(min_str); // Convert the Minute string into integer
  pills[idx].hour = hour; // Assign the Hour value to pills structure
  pills[idx].min = min; // Assign the Minute value to pills structure
   Serial.println(idx);
  Serial.println(hour);
Serial.println(min);
EEPROM.put(idx, pills[idx] );

//}
  
 }

 

  myRTC.updateTime();
 lcd.setCursor(0,1);
 lcd.print(myRTC.hours);
 lcd.print(":");
 lcd.print(myRTC.minutes);
 lcd.print(":");
 lcd.print(myRTC.seconds);
lcd.clear();

for(int i=0 ; i<3 ; i++){
  if(myRTC.hours == pills[i].hour && myRTC.minutes == pills[i].min &&myRTC.seconds == 0){
    // myStepper.step(pills[i].stepperPos);
    // delay(500);
          Serial.println(pills[i].stepperPos);

      myservo.write(90);
      delay(15);
      Serial.println("servo 90");
      myservo.write(0);
      delay(15);
       Serial.println("servo 0");
     // myStepper.step(-pills[i].stepperPos);
  }
}

}

